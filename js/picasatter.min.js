/*
 * Copyright (c) 2012 Kota Tsuyuzaki 
*/
jQuery.fn.reverse = Array.prototype.reverse;
String.prototype.linkify = function(){
    return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,function(m){
        return m.link(m);
      }
    );
};
String.prototype.linkuser = function(){
    return this.replace(/[@]+[A-Za-z0-9-_]+/g,function(u){
        var username = u.replace("@","")
        return u.link("http://twitter.com/"+username);
      }
    );
};
String.prototype.linktag = function(){
    return this.replace(/[#]+[A-Za-z0-9-_]+/,function(t){
        var tag = t.replace("#","%23")
        return t.link("http://search.twitter.com/search?q="+tag);
      }
    );
};


var sort_by = function(field, primer){
   return function(a,b){
       a = a[field];
       b = b[field];
       if (typeof(primer) != 'undefined'){
           a = primer(a);
           b = primer(b);
       }
       if (a<b) return -1;
       if (a>b) return 1;
       return 0;
   }
}

var make_url = function(elem){

    user = elem.attr('user');
    album = elem.attr('album');
    authkey = elem.attr('authkey')

    if(album != window.picasatter['text-'+album]){
        window.picasatter['last_id'+album] = 0;
        window.picasatter['text-'+album] = album;
        window.picasatter['count-'+album] = 12;;
    }
    if(window.picasatter['count-'+album] > 10){
        //elem.prepend('<div class="tweet"><img src="http://picasatter.com/widget/favicon.gif" align="absmiddle" />real time twitter by: <a href="http://picasatter.com" target="_blank">picasatter.com</a></div>');
        window.picasatter['count-'+album] = 0;
    }

    // Picasa Web Album API: https://picasaweb.google.com/data/feed/api/user/
    var url = "https://picasaweb.google.com/data/feed/api/user/"+user+"/albumid/"+album+'?';
    if(authkey){
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&authkey="+authkey+"&callback=?";
    }else{
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&callback=?";
    }
    return url; 
}

function fetch_main_window(id, src, summary){

    //$('#tw'+id); todo hide "new" string on picasatter timeline
    $('#tw'+id+'new').html("");
    $("#main_window").fadeOut(200, function(){
        $(this).attr("src", src);
        $(this).fadeIn(200);
      }
    );
    $("#title").fadeOut(200, function(){
        if(summary)$(this).html(summary);
        else $(this).html("photo_title");
        $(this).fadeIn(200);
      }
    );
}


function slide_show(elem){
    elem = $(elem);
    var url = make_url(elem);
    if(window.picasatter['feed_check']==false){
        setTimeout(function(){slide_show(elem)}, window.picasatter['timeout']);
        return false;
    }
    $.getJSON(url,function(json){

	length = $(json.feed.entry).length;
	num = ~~(Math.random() * length);
	entry = $(json.feed.entry)[num];
        fetch_main_window(entry.content.src)
        setTimeout(function(){slide_show(elem)}, window.picasatter['timeout']);
      }
    );
    return false;
}
function toggle(elem, checker, tmsg, fmsg){
    if(window.picasatter[checker]){
        window.picasatter[checker] = false;
        $(elem).html(fmsg);
    }else{
        window.picasatter[checker] = true;
        $(elem).html(tmsg);
    }
    return false;
}

function highlight_hide(elem, num){
    elem = $(elem);
    elem.css({"background-color":"#EE6"});
    for(i=0; i < num-1; i++){
        elem.fadeOut('slow').fadeIn('fast');
    }
    elem.fadeOut('slow').fadeIn('fast', function(){
        setTimeout(function(){ hideOX();}, 1000);
      }
    );
    return false;
}


function popOX(){
    $('.toolcircle, .toolcross').fadeIn('slow');
    return false;
}

function hideOX(){
    $('.toolcircle, .toolcross').fadeOut('slow',function(){
        $(this).css({"background-color":"#EEE"});
    });
    return false;
}


function scroll(elem, event, delta){
    elem = $(elem);
    if(delta > 0){
        if(window.picasatter['showarray'].length==0) return false;
        id = window.picasatter['showarray'].pop();
        $('#tw'+id).fadeOut('fast').slideUp('fast');
        window.picasatter['hidearray'].push(id);
    }else if(delta < 0){
        if(window.picasatter['hidearray'].length==0) return false;
        id = window.picasatter['hidearray'].pop();
        $('#tw'+id).fadeIn('fast').slideDown('fast');
        window.picasatter['showarray'].push(id);
    }
    return false;
}

function tbody_bind(elem, rows, columns, fn){
    elem = $(elem);
    for(i = 0; i < rows.length; i++){
        for(j = 0; j < columns.length; j++){
            cid = 'd' + rows[i] + columns[j];
            window.picasatter[cid]=false;
            $('#'+cid).bind("click", function(){toggle($(this), $(this).attr('id'), "o", " ");});
        }
    }
}

function blink(elem, interval){
    elem = $(elem);
    fadetime = parseInt(interval/2);
    elem.fadeOut(fadetime).fadeIn(fadetime);
    setTimeout(function(){blink(elem,interval)}, 1800);
    //elem.fadeOut(fadetime).fadeIn(fadetime, setTimeout(function(){blink($(this),interval)}, 0));
}

function draw_table(elem, rows, columns, fn){
    elem = $(elem);

    //create header columns
    var head = '<thead><tr>';
    columns.unshift("#");
    for(i = 0; i < columns.length; i++){
        column = '<th id="h' + columns[i] + '">' + columns[i] + '</th>';
        head += column; 
    }
    head += '</tr></thead><tbody>'
    elem.append(head);

    //create each rows
    for(i = 0; i < rows.length; i++){
        var row = '<tr>';
        for(j = 0; j < columns.length; j++){
            columns.shift();
            columns.unshift(rows[i]);
            if(j==0)row += '<td id="d' + rows[i] + columns[j] + '">'+ rows[i]+ '</td>';
            else row += '<td id="d' + rows[i] + columns[j] + '"> </td>';
        }
        row += '</tr>';
        elem.append(row);
    }

    if(fn) tbody_bind(elem, rows, columns, fn);

    elem.append('</tbody>');
    return false;
}

function fetch_photos(elem){
    
    // initialize div element
    elem = $(elem);
    if(window.picasatter['feed_check']==false){
        setTimeout(function(){fetch_photos(elem)}, window.picasatter['timeout']);
        return false;
    }

    var url = make_url(elem);
    $.getJSON(url,function(json){
        $('div.tweet:gt('+window.picasatter['limit']+')',elem).each(function(){$(this).fadeOut('slow')});
        $(json.feed.entry).each(function(){
            //feed.entry[{content:{src:hoge}}]
            var id = this.gphoto$id.$t;
            if($('#tw'+id, elem).length==0){
                window.picasatter['cotunt-'+album]++;
                //var thedate=new Date(Date.parse(this.created_at));
	        var thedate = new Date();
	        var thedatestr = thedate.getHours()+':'+thedate.getMinutes();
                var src = this.content.src;
                var summary = this.summary.$t;
                //var thedatestr=thedate.getHours()+':'+thedate.getMinutes();
                var divstr = '<div id="tw'+id+'" ><img class="thumbnail" width="200" src="'+
                             src+'" ><div id="tw'+id+'new" class="new">new</div></div>';
                             //this.content.src+'" ><p class="text">hogehoge<br />&nbsp;<b><a href="google.com"'+
                             //'target="_blank">user</a></b> &nbsp;-&nbsp;<b>'+thedatestr+'</b></p></div>';
                window.picasatter['last_id'+album] = id;

                if(window.picasatter['hidearray'].length==0){
                    window.picasatter['showarray'].push(id);
                }else{
                   window.picasatter['hidearray'].unshift(id);
                }

                elem.prepend(divstr);
                $('#tw'+id, elem).hide();
                $('#tw'+id, elem).bind("click", function(){fetch_main_window(id, src, summary);});
                //$('#tw'+this.gphoto$id.$t+' img',elem);  todo overlay "new" string
                $('#tw'+id+' img',elem).hide();
                $('#tw'+id+' img',elem).fadeIn(2000);
                
                //$('#tw'+id+'new',elem).hide();
                blink($('#tw'+id+'new',elem),1000);
                $('#tw'+id, elem).fadeIn('slow');
            }
          }
        );
        album = escape(album);
        rrp = 100;
        setTimeout(function(){fetch_photos(elem)}, rrp);
      }
    );
    return(false);
}

$(document).ready(function(){
    window.picasatter = {'feed_check':false};
    window.picasatter['showarray'] = [];
    window.picasatter['hidearray'] = [];
    $('.picasatter').each(function(e){
        $(this).bind("mousewheel", function(event, delta){
            scroll($(this), event, delta);
            return false;
          }
        );
        rrp = 6;
        fetch_photos(this);
      }
    );
    $('.table').each(function(e){
        rows = $(this).attr('rows');
        rows = rows.split(',');
        columns = $(this).attr('columns');
        columns = columns.split(',');
        draw_table($(this), rows, columns, true);
      }
    );
    $('.photo').each(function(e){
        rrp = 6;
        elem = $(this);
        window.picasatter['timeout'] = (timeout=elem.attr('timeout'))? timeout : 5000 ;
        $(this).bind("mousewheel", function(event, delta){
            scroll($(this), event, delta);
            return false;
          }
        );
        $(this).bind("click", function(){
            popOX();
            return false;
          }
        );
        if(elem.attr('f')=='slideshow'){
            //slide_show($('.picasatter')[0]);
        }
      }
    );
    $('.render').each(function(e){
        $(this).bind("click", function(){toggle($(this), 'feed_check', "starting", "stopping");});
      }
    );
    $('.toolcircle,.toolcross').bind('click', function(){
        highlight_hide($(this), 3);
      }
    );
  }
);

