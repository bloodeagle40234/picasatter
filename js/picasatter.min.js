/*
 * Copyright (c) 2012 Kota Tsuyuzaki 
*/
jQuery.fn.reverse = Array.prototype.reverse;
String.prototype.linkify = function(){
    return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,function(m){
        return m.link(m);
      }
    );
};
String.prototype.linkuser = function(){
    return this.replace(/[@]+[A-Za-z0-9-_]+/g,function(u){
        var username = u.replace("@","")
        return u.link("http://twitter.com/"+username);
      }
    );
};
String.prototype.linktag = function(){
    return this.replace(/[#]+[A-Za-z0-9-_]+/,function(t){
        var tag = t.replace("#","%23")
        return t.link("http://search.twitter.com/search?q="+tag);
      }
    );
};

var sort_by = function(field, primer){
   return function(a,b){
       a = a[field];
       b = b[field];
       if (typeof(primer) != 'undefined'){
           a = primer(a);
           b = primer(b);
       }
       if (a<b) return -1;
       if (a>b) return 1;
       return 0;
   }
}

var make_url = function(elem){

    user = elem.attr('user');
    album = elem.attr('album');
    authkey = elem.attr('authkey')

    if(album != window.picasatter['text-'+album]){
        window.picasatter['last_id'+album] = 0;
        window.picasatter['text-'+album] = album;
        window.picasatter['count-'+album] = 12;;
    }
    if(window.picasatter['count-'+album] > 10){
        //elem.prepend('<div class="tweet"><img src="http://picasatter.com/widget/favicon.gif" align="absmiddle" />real time twitter by: <a href="http://picasatter.com" target="_blank">picasatter.com</a></div>');
        window.picasatter['count-'+album] = 0;
    }

    // Picasa Web Album API: https://picasaweb.google.com/data/feed/api/user/
    var url = "https://picasaweb.google.com/data/feed/api/user/"+user+"/albumid/"+album+'?';
    if(authkey){
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&authkey="+authkey+"&callback=?";
    }else{
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&callback=?";
    }
    return url; 
}

function fetch_main_window(src,summary){
    $("#main_window").fadeOut(200, function(){
        $(this).attr("src",src);
        $(this).fadeIn(200);
      }
    );
    $("#title").fadeOut(200, function(){
        $(this);
        $(this).fadeIn(200);
    );
}

function fetch_main_window(src){
    fetch_main_window(src,"photo_summary"); 
}

function slide_show(elem){
    elem = $(elem);
    var url = make_url(elem);
    if(window.picasatter['feed_check']==false){
        setTimeout(function(){slide_shows(elem)}, window.picasatter['timeout']);
        return false;
    }
    $.getJSON(url,function(json){

	length = $(json.feed.entry).length;
	num = ~~(Math.random() * length);
	entry = $(json.feed.entry)[num];
        fetch_main_window(entry.content.src)
        setTimeout(function(){slide_show(elem)}, window.picasatter['timeout']);
      }
    );
    return false;
}

function fetch_photos(elem){
    
    // initialize div element
    elem = $(elem);
    if(window.picasatter['feed_check']==false){
        setTimeout(function(){fetch_photos(elem)}, window.picasatter['timeout']);
        return false;
    }

    var url = make_url(elem);
    $.getJSON(url,function(json){
        $('div.tweet:gt('+window.picasatter['limit']+')',elem).each(function(){$(this).fadeOut('slow')});
        $(json.feed.entry).each(function(){
            //feed.entry[{content:{src:hoge}}]
            if($('#tw'+this.gphoto$id.$t,elem).length==0){
                window.picasatter['cotunt-'+album]++;
                //var thedate=new Date(Date.parse(this.created_at));
	        var thedate = new Date();
	        var thedatestr = thedate.getHours()+':'+thedate.getMinutes();
                var src = this.content.src;
                var summary = this.summary.$t;
                //var thedatestr=thedate.getHours()+':'+thedate.getMinutes();
                var divstr = '<div id="tw'+this.gphoto$id.$t+'" class="waku"><img class="thumbnail" width="200" src="'+
                             src+'" ><br /><br /><br /></div>';
                             //this.content.src+'" ><p class="text">hogehoge<br />&nbsp;<b><a href="google.com"'+
                             //'target="_blank">user</a></b> &nbsp;-&nbsp;<b>'+thedatestr+'</b></p></div>';
                window.picasatter['last_id'+album] = this.gphoto$id.$t;
                elem.prepend(divstr);
                $('#tw'+this.gphoto$id.$t,elem).hide();
                $('#tw'+this.gphoto$id.$t,elem).bind("click", function(){fetch_main_window(src, summary);});
                $('#tw'+this.gphoto$id.$t+' img',elem).hide();
                $('#tw'+this.gphoto$id.$t+' img',elem).fadeIn(2000);
                $('#tw'+this.gphoto$id.$t,elem).fadeIn('slow');
            }
          }
        );
        album = escape(album);
        rrp = 100;
        setTimeout(function(){fetch_photos(elem)}, rrp);
      }
    );
    return(false);
}


$(document).ready(function(){
    window.picasatter = {'feed_check':false};
    $('.picasatter').each(function(e){
        rrp = 6;
        fetch_photos(this);
      }
    );
    $('.photo').each(function(e){
        rrp = 6;
        elem = $(this);
        window.picasatter['timeout'] = (timeout=elem.attr('timeout'))? timeout : 5000 ;
        if(elem.attr('f')=='slideshow'){
            slide_show($('.picasatter')[0]);
        }
      }
    );
  }
);
$(document).click(function(){
    if(window.picasatter['feed_check']){
        window.picasatter['feed_check'] = false;
    }else{
        window.picasatter['feed_check'] = true;
    }
    $('#rend').toggle();
  }
);
